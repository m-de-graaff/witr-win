name: CI

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all --check
      
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Build
        run: cargo build --all-targets
      
      - name: Run tests (unit tests only)
        run: cargo test --all-targets -- --test-threads=1
      
      - name: Run integration tests (may be flaky)
        continue-on-error: true
        run: cargo test --all-targets -- --ignored --test-threads=1

  build:
    name: Build Release
    needs: check
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release
        run: cargo build --release
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: witr-x86_64-pc-windows-msvc
          path: target/release/witr-win.exe
          if-no-files-found: error

  release:
    name: Release
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Extract version from tag
        id: version
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          Write-Host "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Extracted version: $version"
      
      - name: Build release
        run: cargo build --release
      
      - name: Generate SHA256 checksums
        id: checksums
        run: |
          $exeHash = (Get-FileHash -Path target/release/witr-win.exe -Algorithm SHA256).Hash
          Write-Host "exeHash=$exeHash" >> $env:GITHUB_OUTPUT
          Write-Host "EXEHASH=$exeHash" >> $env:GITHUB_ENV
          "$exeHash  witr-win.exe" | Out-File -FilePath witr-win.exe.sha256 -Encoding utf8
          Write-Host "SHA256 checksum: $exeHash"
          Get-Content witr-win.exe.sha256
      
      - name: Update Scoop manifest
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          $hashLine = Get-Content witr-win.exe.sha256
          $hash = ($hashLine -split '\s+')[0]
          $manifest = Get-Content witr-win.json -Raw | ConvertFrom-Json
          $manifest.version = $version
          $manifest.url = "https://github.com/m-de-graaff/witr-win/releases/download/v$version/witr-win.exe"
          $manifest.hash = "sha256:$hash"
          $manifest.autoupdate.url = "https://github.com/m-de-graaff/witr-win/releases/download/v`$version/witr-win.exe"
          $manifest | ConvertTo-Json -Depth 10 | Set-Content witr-win.json
          Write-Host "Updated Scoop manifest with version $version and hash $hash"
      
      - name: Update Chocolatey package
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          # Update nuspec
          $nuspec = [xml](Get-Content chocolatey/witr-win.nuspec)
          $nuspec.package.metadata.version = $version
          $nuspec.Save("$PWD/chocolatey/witr-win.nuspec")
          # Update install script version
          $installScript = Get-Content chocolatey/tools/chocolateyinstall.ps1 -Raw
          $installScript = $installScript -replace "\$version = '[^']+'", "`$version = '$version'"
          $installScript | Set-Content chocolatey/tools/chocolateyinstall.ps1
          Write-Host "Updated Chocolatey package to version $version"
      
      - name: Update WiX version
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          $wixToml = Get-Content crates/cli/wix.toml -Raw
          $wixToml = $wixToml -replace 'product-version = ".*"', "product-version = `"$version`""
          [System.IO.File]::WriteAllText("$PWD/crates/cli/wix.toml", $wixToml, $utf8NoBom)
          $mainWxs = Get-Content crates/cli/wix/main.wxs -Raw
          $mainWxs = $mainWxs -replace 'Version="[^"]*"', "Version=`"$version`""
          [System.IO.File]::WriteAllText("$PWD/crates/cli/wix/main.wxs", $mainWxs, $utf8NoBom)
          Write-Host "Updated WiX version to $version"
      
      - name: Install cargo-wix
        run: cargo install cargo-wix --locked
      
      - name: Build MSI installer
        run: |
          cd crates/cli
          cargo wix --package witr --nocapture
          if (Test-Path "../../target/wix/witr-win.msi") {
            Write-Host "MSI built successfully"
          } else {
            Write-Error "MSI build failed"
            exit 1
          }
      
      - name: Build Chocolatey package
        run: |
          if (-not (Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" | Out-Null }
          choco pack chocolatey/witr-win.nuspec --output-directory=dist
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          if (Test-Path "dist/witr-win.$version.nupkg") {
            Write-Host "Chocolatey package built successfully"
          } else {
            Write-Error "Chocolatey package build failed"
            exit 1
          }
      
      - name: Create release directory
        run: |
          mkdir release
          Copy-Item target/release/witr-win.exe release/
          Copy-Item README.md release/
          Copy-Item LICENSE release/
      
      - name: Create release archive
        run: |
          Compress-Archive -Path release/* -DestinationPath witr-x86_64-pc-windows-msvc.zip -Force
          $zipHash = (Get-FileHash -Path witr-x86_64-pc-windows-msvc.zip -Algorithm SHA256).Hash
          "$zipHash  witr-x86_64-pc-windows-msvc.zip" | Out-File -FilePath witr-x86_64-pc-windows-msvc.zip.sha256 -Encoding utf8
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/release/witr-win.exe
            witr-win.exe.sha256
            witr-x86_64-pc-windows-msvc.zip
            witr-x86_64-pc-windows-msvc.zip.sha256
            target/wix/witr-win.msi
            dist/witr-win.${{ steps.version.outputs.version }}.nupkg
            witr-win.json
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
